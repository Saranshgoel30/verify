<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --success: #34a853;
            --error: #ea4335;
            --warning: #fbbc05;
            --gray-100: #f1f3f5;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --white: #ffffff;
        }
        
        body {
            background: linear-gradient(135deg, #4895ef 0%, #4361ee 100%);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .card {
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
            padding: 30px;
            width: 95%;
            max-width: 1200px;
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--gray-300);
            padding-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        h1 {
            color: var(--gray-800);
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background-color: var(--gray-100);
        }
        
        .btn-update {
            background-color: var(--primary);
            color: var(--white);
            border: none;
        }
        
        #message {
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .success {
            background-color: #e6f4ea;
            color: var(--success);
            display: block !important;
        }
        
        .error {
            background-color: #fce8e6;
            color: var(--error);
            display: block !important;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-pending { border-top: 4px solid var(--warning); }
        .stat-approved { border-top: 4px solid var(--success); }
        .stat-rejected { border-top: 4px solid var(--error); }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 5px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 5px 0;
        }
        
        .filters-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background-color: var(--gray-100);
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            background-color: var(--white);
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background-color: var(--gray-100);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-300);
        }
        
        th {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        tr:hover {
            background-color: var(--gray-100);
        }
        
        .action-cell {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .status-select {
            padding: 6px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 0;
            color: var(--gray-600);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-300);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 50px 0;
            color: var(--gray-600);
            font-size: 16px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .header-row, .stats-row, .filters-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stat-card {
                min-width: 100%;
            }
            
            .action-cell {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header-row">
                <h1>Point of Contact Dashboard</h1>
                <div class="btn-group">
                    <button id="refreshBtn">Refresh</button>
                    <button id="testConnectionBtn">Test Connection</button>
                </div>
            </div>
            
            <div id="message"></div>
            
            <div class="stats-row">
                <div class="stat-card stat-pending">
                    <span class="stat-label">Pending</span>
                    <span id="statPending" class="stat-number">0</span>
                    <span class="stat-label">Requests</span>
                </div>
                <div class="stat-card stat-approved">
                    <span class="stat-label">Approved</span>
                    <span id="statApproved" class="stat-number">0</span>
                    <span class="stat-label">Requests</span>
                </div>
                <div class="stat-card stat-rejected">
                    <span class="stat-label">Rejected</span>
                    <span id="statRejected" class="stat-number">0</span>
                    <span class="stat-label">Requests</span>
                </div>
            </div>
            <!-- Modal for custom message -->
            <div id="customMessageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; padding:30px; border-radius:10px; max-width:400px; width:90%; box-shadow:0 5px 20px rgba(0,0,0,0.15);">
                    <h2 id="modalTitle" style="margin-bottom:15px; font-size:1.2rem; color:#4361ee;">Custom Message</h2>
                    <textarea id="customMessageInput" rows="4" style="width:100%; padding:10px; border-radius:6px; border:1px solid #dee2e6; margin-bottom:15px;"></textarea>
                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button id="modalCancelBtn" style="background:#eee; color:#333;">Cancel</button>
                        <button id="modalSendBtn" class="btn-update">Send</button>
                    </div>
                </div>
            </div>
            <div id="studentMessageModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Student Message</h2>
                        <span class="close" onclick="closeStudentMessageModal()">&times;</span>
                    </div>
                    <div id="studentMessageText" style="white-space:pre-wrap;"></div>
                </div>
            </div>
            <div id="pocMessageModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Message from PoC</h2>
                        <span class="close" onclick="closePocMessageModal()">&times;</span>
                    </div>
                    <textarea id="pocMessageText" placeholder="Enter your message for the student..." style="width:100%;min-height:80px;"></textarea>
                    <div class="modal-footer">
                        <button onclick="sendPocMessage()" class="btn-update">Send Message</button>
                    </div>
                </div>
            </div>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="pocFilter">Filter by POC</label>
                    <select id="pocFilter" class="filter-select">
                        <option value="">All POCs</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button id="applyFilters" class="btn-update">Apply Filters</button>
                    <button id="clearFilters">Clear Filters</button>
                </div>
            </div>
            
            <div id="requests">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading requests...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        var allRequests = [];
        var stats = { pending: 0, approved: 0, rejected: 0 };
        
        function updateStats(data) {
            // Fetch approved/rejected counts from server
            google.script.run.withSuccessHandler(function(counts) {
                document.getElementById("statApproved").innerText = counts.approved;
                document.getElementById("statRejected").innerText = counts.rejected;
            }).getApprovedRejectedCounts();
            // Pending is still local
            var pending = data.length;
            document.getElementById("statPending").innerText = pending;
        }
        
        function displayRequests(data) {
            if (data.length === 0) {
                document.getElementById("requests").innerHTML = "<div class='no-data'>No matching requests found.</div>";
                return;
            }
            
            var tableHtml = "<div class='table-container'><table><thead><tr><th>Date</th><th>ID</th><th>Name</th><th>Email</th><th>POC</th><th>POC Mail ID</th><th>Status</th><th>Message</th><th>Action</th></tr></thead><tbody>";
            
            data.forEach(function(row) {
                // SCHEMA: [Date, ID, Name, Email, POC, POC Mail ID, Status, Message]
                var formattedDate = "N/A";
                if (row[0] && !isNaN(new Date(row[0]).getTime())) {
                    var requestDate = new Date(row[0]);
                    formattedDate = requestDate.toLocaleDateString() + " " + requestDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                tableHtml += "<tr>";
                tableHtml += "<td>" + formattedDate + "</td>";
                tableHtml += "<td>" + (row[1] || 'N/A') + "</td>";
                tableHtml += "<td>" + (row[2] || 'N/A') + "</td>";
                tableHtml += "<td>" + (row[3] || 'N/A') + "</td>";
                tableHtml += "<td>" + (row[4] || 'N/A') + "</td>";
                tableHtml += "<td>" + (row[5] || 'N/A') + "</td>";
                tableHtml += "<td>" + (row[6] || 'Pending') + "</td>";
                tableHtml += "<td>" + (row[7] || '-') + "</td>";
                tableHtml += "<td class='action-cell'>" +
                    "<button class='btn-view-message' onclick=\"viewStudentMessage('" + String(row[7] || '-').replace(/'/g, "\\'") + "')\">View Student Message</button>" +
                    "<button class='btn-poc-message' onclick=\"openPocMessageModal('" + String(row[1]).replace(/'/g, "\\'") + "', '" + String(row[3]).replace(/'/g, "\\'") + "')\">Message from PoC</button>" +
                    "<select id='status-" + row[1] + "' class='status-select'>" +
                        "<option value='Pending'" + ((row[6]||'Pending') === "Pending" ? " selected" : "") + ">Pending</option>" +
                        "<option value='Approved'" + ((row[6]||'Pending') === "Approved" ? " selected" : "") + ">Approved</option>" +
                        "<option value='Rejected'" + ((row[6]||'Pending') === "Rejected" ? " selected" : "") + ">Rejected</option>" +
                    "</select>" +
                    "<button class='btn-update' onclick=\"handleUpdateRequestStatus('" + String(row[1]).replace(/'/g, "\\'") + "', '" + String(row[3]).replace(/'/g, "\\'") + "')\">Update</button>" +
                "</td>";
                tableHtml += "</tr>";
            });
            
            tableHtml += "</tbody></table></div>";
            document.getElementById("requests").innerHTML = tableHtml;
        }
        
        function loadRequests() {
            document.getElementById("requests").innerHTML = "<div class='loading'><div class='spinner'></div><p>Loading requests...</p></div>";
            document.getElementById("message").style.display = "none";
            
            google.script.run
                .withSuccessHandler(function(data) {
                    console.log('Received data from server:', data); // Debug log
                    if (!Array.isArray(data)) {
                        document.getElementById("requests").innerHTML = "<div class='no-data'>Invalid data received from server.</div>";
                        return;
                    }
                    
                    allRequests = data;
                    populatePocFilter(extractPocNames(data));
                    displayRequests(data);
                    updateStats(data);
                })
                .withFailureHandler(function(error) {
                    document.getElementById("requests").innerHTML = "<div class='no-data'>Error loading data: " + error + "</div>";
                })
                .getPendingRequests();
        }
        
        function extractPocNames(data) {
            var pocs = [];
            var seen = {};
            data.forEach(function(row) {
                if (row[4] && !seen[row[4]]) {
                    pocs.push(row[4]);
                    seen[row[4]] = true;
                }
            });
            return pocs.sort();
        }
        
        function populatePocFilter(pocs) {
            var filterSelect = document.getElementById("pocFilter");
            filterSelect.innerHTML = '<option value="">All POCs</option>';
            
            pocs.forEach(function(poc) {
                var option = document.createElement('option');
                option.value = poc;
                option.textContent = poc;
                filterSelect.appendChild(option);
            });
        }
        
        function applyFilters() {
            var pocFilter = document.getElementById("pocFilter").value;
            var filteredData = allRequests.slice();
            
            if (pocFilter) {
                filteredData = filteredData.filter(function(row) {
                    return row[4] === pocFilter;
                });
            }
            
            displayRequests(filteredData);
            updateStats(filteredData);
        }
        
        function clearFilters() {
            document.getElementById("pocFilter").value = "";
            displayRequests(allRequests);
            updateStats(allRequests);
        }
        
        function handleUpdateRequestStatus(id, email) {
            var statusSelect = document.getElementById("status-" + id);
            var newStatus = statusSelect.value;
            var currentRequest = allRequests.find(req => req[1] === id);
            var currentStatus = currentRequest ? (currentRequest[6] || "Pending") : "Pending";
            if (newStatus === currentStatus) return;
            // Use modal for both approval and rejection
            showCustomMessageModal(newStatus, function(customMsg) {
                if (newStatus === "Rejected" && (!customMsg || !customMsg.trim())) {
                    alert("Rejection reason cannot be empty. Status update cancelled.");
                    statusSelect.value = currentStatus;
                    return;
                }
                updateRequestStatus(id, email, newStatus, customMsg);
            }, newStatus === "Approved" ? "Enter approval message (optional):" : "Enter rejection reason:");
        }
        // Modal logic
        function showCustomMessageModal(status, callback, label) {
            var modal = document.getElementById("customMessageModal");
            var input = document.getElementById("customMessageInput");
            var title = document.getElementById("modalTitle");
            input.value = "";
            title.innerText = label || "Custom Message";
            modal.style.display = "flex";
            function closeModal() {
                modal.style.display = "none";
                document.getElementById("modalSendBtn").onclick = null;
                document.getElementById("modalCancelBtn").onclick = null;
            }
            document.getElementById("modalSendBtn").onclick = function() {
                closeModal();
                callback(input.value);
            };
            document.getElementById("modalCancelBtn").onclick = function() {
                closeModal();
            };
        }
        function updateRequestStatus(id, email, newStatus, rejectionReason) {
            var messageEl = document.getElementById("message");
            messageEl.innerHTML = "Updating status...";
            messageEl.className = "info";
            messageEl.style.display = "block";
            
            google.script.run
                .withSuccessHandler(function(result) {
                    messageEl.innerHTML = result;
                    messageEl.className = "success";
                    loadRequests();
                })
                .withFailureHandler(function(error) {
                    messageEl.innerHTML = "Error: " + error;
                    messageEl.className = "error";
                })
                .updateStatus(id, email, newStatus, rejectionReason);
        }
        
        function testConnection() {
            var messageEl = document.getElementById("message");
            messageEl.innerHTML = "Testing connection...";
            messageEl.className = "info";
            messageEl.style.display = "block";
            
            google.script.run
                .withSuccessHandler(function(result) {
                    messageEl.innerHTML = result;
                    messageEl.className = "success";
                })
                .withFailureHandler(function(error) {
                    messageEl.innerHTML = "Connection error: " + error;
                    messageEl.className = "error";
                })
                .testConnection();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("refreshBtn").addEventListener("click", loadRequests);
            document.getElementById("testConnectionBtn").addEventListener("click", testConnection);
            document.getElementById("applyFilters").addEventListener("click", applyFilters);
            document.getElementById("clearFilters").addEventListener("click", clearFilters);
            loadRequests();
        });
        var pocMessageRequestId = null;
        var pocMessageEmail = null;
        function viewStudentMessage(message) {
            document.getElementById('studentMessageText').textContent = message;
            document.getElementById('studentMessageModal').style.display = 'block';
        }
        function closeStudentMessageModal() {
            document.getElementById('studentMessageModal').style.display = 'none';
        }
        function openPocMessageModal(requestId, email) {
            pocMessageRequestId = requestId;
            pocMessageEmail = email;
            document.getElementById('pocMessageText').value = '';
            document.getElementById('pocMessageModal').style.display = 'block';
        }
        function closePocMessageModal() {
            document.getElementById('pocMessageModal').style.display = 'none';
        }
        function sendPocMessage() {
            var message = document.getElementById('pocMessageText').value;
            if (!message.trim()) {
                alert('Message cannot be empty.');
                return;
            }
            closePocMessageModal();
            document.getElementById('loading').style.display = 'block';
            google.script.run
                .withSuccessHandler(function(response) {
                    document.getElementById('loading').style.display = 'none';
                    showMessage(response.message || response, response.success ? 'success' : 'error');
                    loadRequests();
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    showMessage('Error: ' + error.message, 'error');
                })
                .updatePocMessage(pocMessageRequestId, message);
        }
        
        function applyBulkActions() {
            var selectedAction = document.getElementById('bulkAction').value;
            if (!selectedAction) {
                showMessage('Please select a bulk action.', 'info');
                return;
            }
            var checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage('Please select at least one request.', 'info');
                return;
            }
            var ids = [];
            checkboxes.forEach(function(cb) {
                ids.push(cb.getAttribute('data-id'));
            });
            var message = prompt("Enter a message for all selected students (optional):");
            if (message === null) return;
            document.getElementById('loading').style.display = 'block';
            google.script.run
                .withSuccessHandler(function(response) {
                    document.getElementById('loading').style.display = 'none';
                    if (response.success) {
                        showMessage('Bulk update successful.', 'success');
                        loadRequests();
                    } else {
                        showMessage('Bulk update failed: ' + response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    showMessage('Error: ' + error.message, 'error');
                })
                .bulkUpdateRequestStatus(ids, selectedAction, message);
        }
    </script>
</body>
</html>
